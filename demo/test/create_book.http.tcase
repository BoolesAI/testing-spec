version: "1.0"
description: "Create a new book with valid data"

metadata:
  prompt: |
    Test creating a new book with valid data.
    Verify that the API accepts valid book data and returns
    the created book with a generated ID and location header.
  related_code:
    - "src/controllers/books.ts"
    - "src/services/bookService.ts"
  test_category: "functional"
  risk_level: "high"
  tags: ["books", "create", "post"]
  priority: "high"
  timeout: "5s"

environment:
  name: "${ENV_NAME|local}"
  host: "${API_HOST|localhost:3000}"
  scheme: "http"

variables:
  random_suffix: "${random_int(1000000000, 9999999999)}"
  new_isbn: "978${random_suffix}"

http:
  method: "POST"
  path: "/api/v1/books"
  headers:
    Content-Type: "application/json"
    Accept: "application/json"
  body:
    json:
      title: "Test Book ${random_suffix}"
      author: "Test Author"
      isbn: "${new_isbn}"
      publicationDate: "2024-01-15"
      price: 29.99
      inventoryQuantity: 10

assertions:
  - type: "json_path"
    expression: "$.status"
    expected: 201
  - type: "json_path"
    expression: "$.id"
    operator: "exists"
  - type: "json_path"
    expression: "$.title"
    operator: "contains"
    expected: "Test Book"
  - type: "json_path"
    expression: "$.author"
    expected: "Test Author"
  - type: "json_path"
    expression: "$.price"
    expected: 29.99
  - type: "json_path"
    expression: "$.inventoryQuantity"
    expected: 10
  - type: "json_path"
    expression: "$.header['Location']"
    operator: "matches"
    pattern: "^/api/v1/books/\\d+$"
  - type: "response_time"
    max_ms: 2000

lifecycle:
  teardown:
    - action: "extract"
      scope: "assert"
      vars:
        created_book_id: "$.id"
